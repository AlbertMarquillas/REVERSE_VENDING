// main.cpp
#include "comms.h"
#include "camera.h"
#include "classifier.h"
#include <iostream>
#include <unistd.h>

#define MQTT_TOPIC "sensor/datos"
#define MQTT_RESPONSE_TOPIC "sensor/comandos"

Comms comms("192.168.1.100", 1883, MQTT_TOPIC, MQTT_RESPONSE_TOPIC);
Camera camera;
Classifier classifier("model.ts");

void message_callback(const std::string& message) {
    std::cout << "Mensaje MQTT recibido: " << message << std::endl;
    
    if (camera.detect_object()) {
        std::string image_path = camera.capture_image();
        std::string classification = classifier.predict(image_path);
        
        std::cout << "ClasificaciÃ³n: " << classification << std::endl;
        if (classification == "correcto") {
            comms.send_message("parar");
        }
    }
}

int main() {
    comms.set_callback(message_callback);
    comms.connect();
    
    while (true) {
        comms.loop();
        usleep(500000);  // Espera 500ms
    }
    
    return 0;
}